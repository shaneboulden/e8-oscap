---
###############################################################################
#
# Ansible Playbook for Essential Eight System Hardening for Red Hat Enterprise Linux 7 Systems
#
# Profile Description:
# This profile is derived from the
# Standard System Security profile, providing system hardening for Red Hat Enterprise Linux 7 systems 
# aligned with the Australian Cyber Security Centre (ACSC) Essential Eight.
#
# Profile ID:  xccdf_com.redhat.apac_profile_aus_essential_eight
# Benchmark ID:  RHEL-7
# Benchmark Version:  0.1.40
# XCCDF Version:  1.1
#
# This file was generated by OpenSCAP 1.3.1 using:
# $ oscap xccdf generate fix --profile xccdf_com.redhat.apac_profile_aus_essential_eight --fix-type ansible xccdf-file.xml
#
# This Ansible Playbook is generated from an OpenSCAP profile without preliminary evaluation.
# It attempts to fix every selected rule, even if the system is already compliant.
#
# Additional fixes have been included to meet the scanning requirements of the Essential Eight tailoring file.
#
# How to apply this Ansible Playbook:
# $ ansible-playbook -i "localhost," -c local playbook.yml
# $ ansible-playbook -i "192.168.1.155," playbook.yml
# $ ansible-playbook -i inventory.ini playbook.yml
#
###############################################################################


- hosts: all
  become: true
  vars:
  tasks:

    - name: Ensure /dev/shm line in /etc/fstab
      lineinfile:
        path: /etc/fstab
        regexp: ^tmpfs\s\/dev\/shm
        line: "tmpfs /dev/shm tmpfs rw,nosuid,nodev,noexec,seclabel 0 0"

    - name: Ensure rsh is removed
      package:
        name: "{{item}}"
        state: absent
      with_items:
        - rsh
      tags:
        - package_rsh_removed
        - unknown_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27274-0
        - NIST-800-171-3.1.13

    - name: Ensure rsh-server is removed
      package:
        name: "{{item}}"
        state: absent
      with_items:
        - rsh-server
      tags:
        - package_rsh-server_removed
        - high_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27342-5
        - NIST-800-53-AC-17(8)
        - NIST-800-53-CM-7(a)
        - DISA-STIG-RHEL-07-020000

    - name: Ensure telnet is removed
      package:
        name: "{{item}}"
        state: absent
      with_items:
        - telnet
      tags:
        - package_telnet_removed
        - low_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27305-2
        - NIST-800-171-3.1.13

    - name: Disable service telnet
      service:
        name: "{{item}}"
        enabled: "no"
        state: "stopped"
      register: service_result
      failed_when: "service_result is failed and ('Could not find the requested service' not in service_result.msg)"
      with_items:
        - telnet
      tags:
        - service_telnet_disabled
        - high_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27401-9
        - NIST-800-53-AC-17(8)
        - NIST-800-53-CM-7
        - NIST-800-53-IA-5(1)(c)
        - NIST-800-171-3.1.13
        - NIST-800-171-3.4.7
    - name: Disable socket of service telnet if applicable
      service:
        name: "{{item}}"
        enabled: "no"
        state: "stopped"
      register: socket_result
      failed_when: "socket_result is failed and ('Could not find the requested service' not in socket_result.msg)"
      with_items:
        - telnet.socket
      tags:
        - service_telnet_disabled
        - high_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27401-9
        - NIST-800-53-AC-17(8)
        - NIST-800-53-CM-7
        - NIST-800-53-IA-5(1)(c)
        - NIST-800-171-3.1.13
        - NIST-800-171-3.4.7

    - name: Ensure telnet-server is removed
      package:
        name: "{{item}}"
        state: absent
      with_items:
        - telnet-server
      tags:
        - package_telnet-server_removed
        - high_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27165-0
        - NIST-800-53-AC-17(8)
        - NIST-800-53-CM-7(a)
        - DISA-STIG-RHEL-07-021710

    - name: Ensure ypbind is removed
      package:
        name: "{{item}}"
        state: absent
      with_items:
        - ypbind
      tags:
        - package_ypbind_removed
        - unknown_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27396-1

    - name: Disable service xinetd
      service:
        name: "{{item}}"
        enabled: "no"
        state: "stopped"
      register: service_result
      failed_when: "service_result is failed and ('Could not find the requested service' not in service_result.msg)"
      with_items:
        - xinetd
      tags:
        - service_xinetd_disabled
        - medium_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27443-1
        - NIST-800-53-AC-17(8)
        - NIST-800-53-CM-7
        - NIST-800-171-3.4.7
    - name: Disable socket of service xinetd if applicable
      service:
        name: "{{item}}"
        enabled: "no"
        state: "stopped"
      register: socket_result
      failed_when: "socket_result is failed and ('Could not find the requested service' not in socket_result.msg)"
      with_items:
        - xinetd.socket
      tags:
        - service_xinetd_disabled
        - medium_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27443-1
        - NIST-800-53-AC-17(8)
        - NIST-800-53-CM-7
        - NIST-800-171-3.4.7

    - name: Ensure xinetd is removed
      package:
        name: "{{item}}"
        state: absent
      with_items:
        - xinetd
      tags:
        - package_xinetd_removed
        - unknown_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27354-0
        - NIST-800-53-AC-17(8)
        - NIST-800-53-CM-7

    - name: Ensure talk is removed
      package:
        name: "{{item}}"
        state: absent
      with_items:
        - talk
      tags:
        - package_talk_removed
        - unknown_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27432-4

    - name: Ensure talk-server is removed
      package:
        name: "{{item}}"
        state: absent
      with_items:
        - talk-server
      tags:
        - package_talk-server_removed
        - medium_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27210-4

    - name: Ensure quagga is removed
      package:
        name: "{{item}}"
        state: absent
      with_items:
        - quagga
      tags:
        - package_quagga_removed
        - medium_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27594-1
        - NIST-800-53-SC-32
        - DISA-STIG-RHEL-07-TBD

    - name: Disable service zebra
      service:
        name: "{{item}}"
        enabled: "no"
        state: "stopped"
      register: service_result
      failed_when: "service_result is failed and ('Could not find the requested service' not in service_result.msg)"
      with_items:
        - zebra
      tags:
        - service_zebra_disabled
        - medium_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27191-6
        - NIST-800-53-SC-32
    - name: Disable socket of service zebra if applicable
      service:
        name: "{{item}}"
        enabled: "no"
        state: "stopped"
      register: socket_result
      failed_when: "socket_result is failed and ('Could not find the requested service' not in socket_result.msg)"
      with_items:
        - zebra.socket
      tags:
        - service_zebra_disabled
        - medium_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-27191-6
        - NIST-800-53-SC-32

    - name: Disable service squid
      service:
        name: "{{item}}"
        enabled: "no"
        state: "stopped"
      register: service_result
      failed_when: "service_result is failed and ('Could not find the requested service' not in service_result.msg)"
      with_items:
        - squid
      tags:
        - service_squid_disabled
        - unknown_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-80285-0
    - name: Disable socket of service squid if applicable
      service:
        name: "{{item}}"
        enabled: "no"
        state: "stopped"
      register: socket_result
      failed_when: "socket_result is failed and ('Could not find the requested service' not in socket_result.msg)"
      with_items:
        - squid.socket
      tags:
        - service_squid_disabled
        - unknown_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-80285-0

    - name: Ensure squid is removed
      package:
        name: "{{item}}"
        state: absent
      with_items:
        - squid
      tags:
        - package_squid_removed
        - unknown_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-80286-8

    - name: Disable service avahi-daemon
      service:
        name: "{{item}}"
        enabled: "no"
        state: "stopped"
      register: service_result
      failed_when: "service_result is failed and ('Could not find the requested service' not in service_result.msg)"
      with_items:
        - avahi-daemon
      tags:
        - service_avahi-daemon_disabled
        - unknown_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-80338-7
        - NIST-800-53-CM-7
    - name: Disable socket of service avahi-daemon if applicable
      service:
        name: "{{item}}"
        enabled: "no"
        state: "stopped"
      register: socket_result
      failed_when: "socket_result is failed and ('Could not find the requested service' not in socket_result.msg)"
      with_items:
        - avahi-daemon.socket
      tags:
        - service_avahi-daemon_disabled
        - unknown_severity
        - disable_strategy
        - low_complexity
        - low_disruption
        - CCE-80338-7
        - NIST-800-53-CM-7

    - name: "Enable Use of Strict Mode Checking"
      lineinfile:
        create: yes
        dest: /etc/ssh/sshd_config
        regexp: (?i)^#?strictmodes
        line: StrictModes yes
        validate: sshd -t -f %s
      #notify: restart sshd
      tags:
        - sshd_enable_strictmodes
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-80222-3
        - NIST-800-53-AC-6
        - NIST-800-171-3.1.12
        - DISA-STIG-RHEL-07-040450

    - name: "Disable SSH Support for User Known Hosts"
      lineinfile:
        create: yes
        dest: /etc/ssh/sshd_config
        regexp: ^IgnoreUserKnownHosts
        line: IgnoreUserKnownHosts yes
        validate: sshd -t -f %s
      #notify: restart sshd
      tags:
        - sshd_disable_user_known_hosts
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-80372-6
        - NIST-800-53-CM-6(a)
        - NIST-800-171-3.1.12
        - DISA-STIG-RHEL-07-040380

    - name: Disable SSH Access via Empty Passwords
      lineinfile:
        create: yes
        dest: /etc/ssh/sshd_config
        regexp: ^PermitEmptyPasswords
        line: PermitEmptyPasswords no
        validate: sshd -t -f %s
      tags:
        - sshd_disable_empty_passwords
        - high_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27471-2
        - NIST-800-53-AC-3
        - NIST-800-53-AC-6
        - NIST-800-53-CM-6(b)
        - NIST-800-171-3.1.1
        - NIST-800-171-3.1.5
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-010300

    - name: "Allow Only SSH Protocol 2"
      lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: "^Protocol [0-9]"
        line: "Protocol 2"
        validate: sshd -t -f %s
      #notify: :reload ssh
      tags:
        - sshd_allow_only_protocol2
        - high_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27320-1
        - NIST-800-53-AC-17(8).1(ii)
        - NIST-800-53-IA-5(1)(c)
        - NIST-800-171-3.1.13
        - NIST-800-171-3.5.4
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-040390

    - name: Disable SSH Support for .rhosts Files
      lineinfile:
        create: yes
        dest: /etc/ssh/sshd_config
        regexp: ^IgnoreRhosts
        line: IgnoreRhosts yes
        validate: sshd -t -f %s
      tags:
        - sshd_disable_rhosts
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27377-1
        - NIST-800-53-AC-3
        - NIST-800-53-CM-6(a)
        - NIST-800-171-3.1.12
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-040350

    - name: Disable SSH Support for Rhosts RSA Authentication
      lineinfile:
        create: yes
        dest: /etc/ssh/sshd_config
        regexp: ^RhostsRSAAuthentication
        line: RhostsRSAAuthentication no
        validate: sshd -t -f %s
      tags:
        - sshd_disable_rhosts_rsa
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-80373-4
        - NIST-800-53-CM-6(a)
        - NIST-800-171-3.1.12
        - DISA-STIG-RHEL-07-040330

    - name: Do Not Allow SSH Environment Options
      lineinfile:
        create: yes
        dest: /etc/ssh/sshd_config
        regexp: ^PermitUserEnvironment
        line: PermitUserEnvironment no
        validate: sshd -t -f %s
      tags:
        - sshd_do_not_permit_user_env
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27363-1
        - NIST-800-53-CM-6(b)
        - NIST-800-171-3.1.12
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-010460

    - name: Disable Host-Based Authentication
      lineinfile:
        create: yes
        dest: /etc/ssh/sshd_config
        regexp: ^HostbasedAuthentication
        line: HostbasedAuthentication no
      tags:
        - disable_host_auth
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27413-4
        - NIST-800-53-AC-3
        - NIST-800-53-CM-6(b)
        - NIST-800-171-3.1.12
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-010470

    - name: "Enable use of Privilege Separation"
      lineinfile:
        create: yes
        dest: /etc/ssh/sshd_config
        regexp: (?i)^#?useprivilegeseparation
        line: UsePrivilegeSeparation sandbox
        validate: sshd -t -f %s
      #notify: restart sshd
      tags:
        - sshd_use_priv_separation
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-80223-1
        - NIST-800-53-AC-6
        - NIST-800-171-3.1.12
        - DISA-STIG-RHEL-07-040460

    - name: Print last log
      lineinfile:
        create: yes
        dest: /etc/ssh/sshd_config
        regexp: ^PrintLastLog
        line: PrintLastLog yes
        validate: sshd -t -f %s
      #notify: restart sshd
      tags:
        - sshd_print_last_log
        - medium_severity
        - CCE-80225-6
        - NIST-800-53-AC-9
        - DISA-STIG-RHEL-07-040360

    - name: "Disable GSSAPI Authentication"
      lineinfile:
        create: yes
        dest: /etc/ssh/sshd_config
        regexp: (?i)^#?gssapiauthentication
        line: GSSAPIAuthentication no
        validate: sshd -t -f %s
      #notify: sshd -t -f %s
      tags:
        - sshd_disable_gssapi_auth
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-80220-7
        - NIST-800-53-CM-6(c)
        - NIST-800-171-3.1.12
        - DISA-STIG-RHEL-07-040430

    - name: "Disable SSH Root Login"
      lineinfile:
        create: yes
        dest: "/etc/ssh/sshd_config"
        regexp: "^PermitRootLogin"
        line: "PermitRootLogin no"
        insertafter: '(?i)^#?authentication'
        validate: sshd -t -f %s
      #notify: restart sshd
      tags:
        - sshd_disable_root_login
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27445-6
        - NIST-800-53-AC-3
        - NIST-800-53-AC-6(2)
        - NIST-800-53-IA-2(1)
        - NIST-800-53-IA-2(5)
        - NIST-800-171-3.1.1
        - NIST-800-171-3.1.5
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-040370

    - name: Enable service auditd
      service:
        name: "{{item}}"
        enabled: "yes"
        state: "started"
      with_items:
        - auditd
      tags:
        - service_auditd_enabled
        - high_severity
        - enable_strategy
        - low_complexity
        - low_disruption
        - CCE-27407-6
        - NIST-800-53-AU-3
        - NIST-800-53-AC-17(1)
        - NIST-800-53-AU-1(b)
        - NIST-800-53-AU-10
        - NIST-800-53-AU-12(a)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-14(1)
        - NIST-800-53-IR-5
        - NIST-800-171-3.3.1
        - NIST-800-171-3.3.2
        - NIST-800-171-3.3.6
        - PCI-DSS-Req-10
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030000

    - name: Enable service rsyslog
      service:
        name: "{{item}}"
        enabled: "yes"
        state: "started"
      with_items:
        - rsyslog
      tags:
        - service_rsyslog_enabled
        - medium_severity
        - enable_strategy
        - low_complexity
        - low_disruption
        - CCE-80188-6
        - NIST-800-53-AU-4(1)
        - NIST-800-53-AU-12

    - name: Ensure rsyslog is installed
      package:
        name: "{{item}}"
        state: present
      with_items:
        - rsyslog
      tags:
        - package_rsyslog_installed
        - medium_severity
        - enable_strategy
        - low_complexity
        - low_disruption
        - CCE-80187-8
        - NIST-800-53-AU-9(2)

    - name: Enable service firewalld
      service:
        name: "{{item}}"
        enabled: "yes"
        state: "started"
      with_items:
        - firewalld
      tags:
        - service_firewalld_enabled
        - medium_severity
        - enable_strategy
        - low_complexity
        - low_disruption
        - CCE-27361-5
        - NIST-800-53-CM-6(b)
        - NIST-800-171-3.1.3
        - NIST-800-171-3.4.7
        - DISA-STIG-RHEL-07-040520

    - name: Ensure firewalld is installed
      package:
        name: "{{item}}"
        state: present
      with_items:
        - firewalld
      tags:
        - package_firewalld_installed
        - medium_severity
        - enable_strategy
        - low_complexity
        - low_disruption

    - name: XCCDF Value var_selinux_state # promote to variable
      set_fact:
        var_selinux_state: !!str |-
            enforcing
      tags:
        - always
    - name: "Ensure SELinux State is Enforcing"
      lineinfile:
        path: /etc/sysconfig/selinux
        regexp: '^SELINUX='
        line: "SELINUX={{ var_selinux_state }}"
        create: yes
      tags:
        - selinux_state
        - high_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27334-2
        - NIST-800-53-AC-3
        - NIST-800-53-AC-3(3)
        - NIST-800-53-AC-3(4)
        - NIST-800-53-AC-4
        - NIST-800-53-AC-6
        - NIST-800-53-AU-9
        - NIST-800-53-SI-6(a)
        - NIST-800-171-3.1.2
        - NIST-800-171-3.7.2
        - DISA-STIG-RHEL-07-020210

    - name: "Prevent Log In to Accounts With Empty Password - system-auth"
      replace:
        dest: /etc/pam.d/system-auth
        follow: yes
        regexp: 'nullok'
      tags:
        - no_empty_passwords
        - high_severity
        - configure_strategy
        - low_complexity
        - medium_disruption
        - CCE-27286-4
        - NIST-800-53-AC-6
        - NIST-800-53-IA-5(b)
        - NIST-800-53-IA-5(c)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-171-3.1.1
        - NIST-800-171-3.1.5
        - PCI-DSS-Req-8.2.3
        - CJIS-5.5.2
        - DISA-STIG-RHEL-07-010290
    - name: "Prevent Log In to Accounts With Empty Password - password-auth"
      replace:
        dest: /etc/pam.d/password-auth
        follow: yes
        regexp: 'nullok'
      tags:
        - no_empty_passwords
        - high_severity
        - configure_strategy
        - low_complexity
        - medium_disruption
        - CCE-27286-4
        - NIST-800-53-AC-6
        - NIST-800-53-IA-5(b)
        - NIST-800-53-IA-5(c)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-171-3.1.1
        - NIST-800-171-3.1.5
        - PCI-DSS-Req-8.2.3
        - CJIS-5.5.2
        - DISA-STIG-RHEL-07-010290

    - name: "Read list of files with incorrect permissions"
      shell: "rpm -Va | grep '^.M' | cut -d ' ' -f5- | sed -r '/^$/d' | sed -r 's;^.*\\s+(.+);\\1;g'"
      register: files_with_incorrect_permissions
      failed_when: False
      changed_when: False
      check_mode: no
      tags:
        - rpm_verify_permissions
        - high_severity
        - restrict_strategy
        - high_complexity
        - medium_disruption
        - CCE-27209-6
        - NIST-800-53-AC-6
        - NIST-800-53-AU-9(1)
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-CM-6(3)
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - PCI-DSS-Req-11.5
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010010
    - name: "Correct file permissions with RPM"
      shell: "rpm --quiet --setperms $(rpm -qf '{{item}}')"
      with_items: "{{ files_with_incorrect_permissions.stdout_lines }}"
      when: files_with_incorrect_permissions.stdout_lines | length > 0
      tags:
        - rpm_verify_permissions
        - high_severity
        - restrict_strategy
        - high_complexity
        - medium_disruption
        - CCE-27209-6
        - NIST-800-53-AC-6
        - NIST-800-53-AU-9(1)
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-CM-6(3)
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - PCI-DSS-Req-11.5
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010010

    - name: "Set fact: Package manager reinstall command (dnf)"
      set_fact:
        package_manager_reinstall_cmd: dnf reinstall -y
      when: ansible_distribution == "Fedora"
      tags:
        - rpm_verify_hashes
        - high_severity
        - unknown_strategy
        - high_complexity
        - medium_disruption
        - CCE-27157-7
        - NIST-800-53-CM-6(d)
        - NIST-800-53-CM-6(3)
        - NIST-800-53-SI-7(1)
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - PCI-DSS-Req-11.5
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010020
    - name: "Set fact: Package manager reinstall command (yum)"
      set_fact:
        package_manager_reinstall_cmd: yum reinstall -y
      when: ansible_distribution == "RedHat" or ansible_distribution == "OracleLinux"
      tags:
        - rpm_verify_hashes
        - high_severity
        - unknown_strategy
        - high_complexity
        - medium_disruption
        - CCE-27157-7
        - NIST-800-53-CM-6(d)
        - NIST-800-53-CM-6(3)
        - NIST-800-53-SI-7(1)
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - PCI-DSS-Req-11.5
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010020
    - name: "Read files with incorrect hash"
      shell: "rpm -Va | grep -E '^..5.* /(bin|sbin|lib|lib64|usr)/' | sed -r 's;^.*\\s+(.+);\\1;g'"
      register: files_with_incorrect_hash
      changed_when: False
      when: package_manager_reinstall_cmd is defined
      check_mode: no
      tags:
        - rpm_verify_hashes
        - high_severity
        - unknown_strategy
        - high_complexity
        - medium_disruption
        - CCE-27157-7
        - NIST-800-53-CM-6(d)
        - NIST-800-53-CM-6(3)
        - NIST-800-53-SI-7(1)
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - PCI-DSS-Req-11.5
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010020
    - name: "Reinstall packages of files with incorrect hash"
      shell: "{{package_manager_reinstall_cmd}} $(rpm -qf '{{item}}')"
      with_items: "{{ files_with_incorrect_hash.stdout_lines }}"
      when: package_manager_reinstall_cmd is defined and (files_with_incorrect_hash.stdout_lines | length > 0)
      tags:
        - rpm_verify_hashes
        - high_severity
        - unknown_strategy
        - high_complexity
        - medium_disruption
        - CCE-27157-7
        - NIST-800-53-CM-6(d)
        - NIST-800-53-CM-6(3)
        - NIST-800-53-SI-7(1)
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - PCI-DSS-Req-11.5
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010020

    - name: Find All Yum Repositories
      find:
        paths: "/etc/yum.repos.d/"
        patterns: "*.repo"
      register: yum_find
    - name: Ensure gpgcheck Enabled For All Yum Package Repositories
      with_items: "{{ yum_find.files }}"
      lineinfile:
        create: yes
        dest: "{{ item.path }}"
        regexp: '^gpgcheck'
        line: 'gpgcheck=1'
      tags:
        - ensure_gpgcheck_never_disabled
        - high_severity
        - unknown_strategy
        - low_complexity
        - medium_disruption
        - CCE-26876-3
        - NIST-800-53-CM-5(3)
        - NIST-800-53-SI-7
        - NIST-800-53-MA-1(b)
        - NIST-800-171-3.4.8
        - PCI-DSS-Req-6.2
        - CJIS-5.10.4.1

    - name: "Security patches are up to date"
      package:
        name: "*"
        state: "latest"
      tags:
        - security_patches_up_to_date
        - high_severity
        - patch_strategy
        - low_complexity
        - high_disruption
        - CCE-26895-3
        - NIST-800-53-SI-2
        - NIST-800-53-SI-2(c)
        - NIST-800-53-MA-1(b)
        - PCI-DSS-Req-6.2
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-020260

    - name: "Read permission of GPG key directory"
      stat:
        path: /etc/pki/rpm-gpg/
      register: gpg_key_directory_permission
      check_mode: no
      tags:
        - ensure_redhat_gpgkey_installed
        - high_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-26957-1
        - NIST-800-53-CM-5(3)
        - NIST-800-53-SI-7
        - NIST-800-53-MA-1(b)
        - NIST-800-171-3.4.8
        - PCI-DSS-Req-6.2
        - CJIS-5.10.4.1

    # It should fail if it doesn't find any fingerprints in file - maybe file was not parsed well.
    - name: Read signatures in GPG key
      shell: gpg --with-fingerprint '/etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release' | grep 'Key fingerprint =' | tr -s ' ' | sed 's;.*= ;;g'
      changed_when: False
      register: gpg_fingerprints
      check_mode: no
      tags:
        - ensure_redhat_gpgkey_installed
        - high_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-26957-1
        - NIST-800-53-CM-5(3)
        - NIST-800-53-SI-7
        - NIST-800-53-MA-1(b)
        - NIST-800-171-3.4.8
        - PCI-DSS-Req-6.2
        - CJIS-5.10.4.1
    - name: Set Fact - Valid fingerprints
      set_fact:
         gpg_valid_fingerprints: ("567E 347A D004 4ADE 55BA 8A5F 199E 2F91 FD43 1D51" "43A6 E49C 4A38 F4BE 9ABF 2A53 4568 9C88 2FA6 58E0")
      tags:
        - ensure_redhat_gpgkey_installed
        - high_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-26957-1
        - NIST-800-53-CM-5(3)
        - NIST-800-53-SI-7
        - NIST-800-53-MA-1(b)
        - NIST-800-171-3.4.8
        - PCI-DSS-Req-6.2
        - CJIS-5.10.4.1
    - name: Import RedHat GPG key
      rpm_key:
        state: present
        key: /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
      when:
        (gpg_key_directory_permission.stat.mode <= '0755')
        and (( gpg_fingerprints.stdout_lines | difference(gpg_valid_fingerprints)) | length == 0)
        and (gpg_fingerprints.stdout_lines | length > 0)
        and (ansible_distribution == "RedHat")
      tags:
        - ensure_redhat_gpgkey_installed
        - high_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-26957-1
        - NIST-800-53-CM-5(3)
        - NIST-800-53-SI-7
        - NIST-800-53-MA-1(b)
        - NIST-800-171-3.4.8
        - PCI-DSS-Req-6.2
        - CJIS-5.10.4.1

    - name: "Read list libraries without root ownership"
      shell: "find -L /usr/lib /usr/lib64 /lib /lib64 \\! -user root"
      register: libraries_not_owned_by_root
      changed_when: False
      failed_when: False
      check_mode: no
      tags:
        - file_ownership_library_dirs
        - medium_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-26648-6
        - NIST-800-53-AC-6
    - name: "Set ownership of system libraries to root"
      file:
        path: "{{item}}"
        owner: "root"
      with_items: "{{ libraries_not_owned_by_root.stdout_lines }}"
      when: libraries_not_owned_by_root | length > 0
      tags:
        - file_ownership_library_dirs
        - medium_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-26648-6
        - NIST-800-53-AC-6

    - name: "Read list of world and group writable system executables"
      shell: "find /bin /usr/bin /usr/local/bin /sbin /usr/sbin /usr/local/sbin /usr/libexec -perm /022 -type f"
      register: world_writable_library_files
      changed_when: False
      failed_when: False
      check_mode: no
      tags:
        - file_permissions_binary_dirs
        - medium_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-27075-1
        - NIST-800-53-AC-6
    - name: "Remove world/group writability of system executables"
      file:
        path: "{{item}}"
        mode: "go-w"
      with_items: "{{ world_writable_library_files.stdout_lines }}"
      when: world_writable_library_files.stdout_lines | length > 0
      tags:
        - file_permissions_binary_dirs
        - medium_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-27075-1
        - NIST-800-53-AC-6

    - name: "Read list of system executables without root ownership"
      shell: "find /bin/ /usr/bin/ /usr/local/bin/ /sbin/ /usr/sbin/ /usr/local/sbin/ /usr/libexec \\! -user root"
      register: no_root_system_executables
      changed_when: False
      failed_when: False
      check_mode: no
      tags:
        - file_ownership_binary_dirs
        - medium_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-27119-7
        - NIST-800-53-AC-6
    - name: "Set ownership to root of system executables"
      file:
        path: "{{item}}"
        owner: "root"
      with_items: "{{ no_root_system_executables.stdout_lines }}"
      when: no_root_system_executables.stdout_lines | length > 0
      tags:
        - file_ownership_binary_dirs
        - medium_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-27119-7
        - NIST-800-53-AC-6

    - name: "Read list of world and group writable files in libraries directories"
      shell: "find /lib /lib64 /usr/lib /usr/lib64 -perm /022 -type f"
      register: world_writable_library_files
      changed_when: False
      failed_when: False
      check_mode: no
      tags:
        - file_permissions_library_dirs
        - medium_severity
        - restrict_strategy
        - high_complexity
        - medium_disruption
        - CCE-26966-2
        - NIST-800-53-AC-6
    - name: "Disable world/group writability to library files"
      file:
        path: "{{item}}"
        mode: "go-w"
      with_items: "{{ world_writable_library_files.stdout_lines }}"
      when: world_writable_library_files.stdout_lines | length > 0
      tags:
        - file_permissions_library_dirs
        - medium_severity
        - restrict_strategy
        - high_complexity
        - medium_disruption
        - CCE-26966-2
        - NIST-800-53-AC-6

    - name: get back device associated to mountpoint
      shell: mount | grep ' /dev/shm ' |cut -d ' ' -f 1
      register: device_name
      check_mode: no
      tags:
        - mount_option_dev_shm_nosuid
        - unknown_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80154-8
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    - name: get back device previous mount option
      shell: mount | grep ' /dev/shm ' | sed -re 's:.*\((.*)\):\1:'
      register: device_cur_mountoption
      check_mode: no
      tags:
        - mount_option_dev_shm_nosuid
        - unknown_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80154-8
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    - name: get back device fstype
      shell: mount | grep ' /dev/shm ' | cut -d ' ' -f 5
      register: device_fstype
      check_mode: no
      tags:
        - mount_option_dev_shm_nosuid
        - unknown_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80154-8
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    - name: Ensure permission nosuid are set on /dev/shm
      mount:
        path: "/dev/shm"
        src: "{{device_name.stdout}}"
        opts: "{{device_cur_mountoption.stdout}},nosuid"
        state: "mounted"
        fstype: "{{device_fstype.stdout}}"
      tags:
        - mount_option_dev_shm_nosuid
        - unknown_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80154-8
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2

    - name: get back device associated to mountpoint
      shell: mount | grep ' /dev/shm ' |cut -d ' ' -f 1
      register: device_name
      check_mode: no
      tags:
        - mount_option_dev_shm_noexec
        - unknown_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80153-0
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    - name: get back device previous mount option
      shell: mount | grep ' /dev/shm ' | sed -re 's:.*\((.*)\):\1:'
      register: device_cur_mountoption
      check_mode: no
      tags:
        - mount_option_dev_shm_noexec
        - unknown_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80153-0
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    - name: get back device fstype
      shell: mount | grep ' /dev/shm ' | cut -d ' ' -f 5
      register: device_fstype
      check_mode: no
      tags:
        - mount_option_dev_shm_noexec
        - unknown_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80153-0
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    - name: Ensure permission noexec are set on /dev/shm
      mount:
        path: "/dev/shm"
        src: "{{device_name.stdout}}"
        opts: "{{device_cur_mountoption.stdout}},noexec"
        state: "mounted"
        fstype: "{{device_fstype.stdout}}"
      tags:
        - mount_option_dev_shm_noexec
        - unknown_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80153-0
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2

    - name: get back device associated to mountpoint
      shell: mount | grep ' /dev/shm ' |cut -d ' ' -f 1
      register: device_name
      check_mode: no
      tags:
        - mount_option_dev_shm_nodev
        - unknown_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80152-2
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    - name: get back device previous mount option
      shell: mount | grep ' /dev/shm ' | sed -re 's:.*\((.*)\):\1:'
      register: device_cur_mountoption
      check_mode: no
      tags:
        - mount_option_dev_shm_nodev
        - unknown_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80152-2
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    - name: get back device fstype
      shell: mount | grep ' /dev/shm ' | cut -d ' ' -f 5
      register: device_fstype
      check_mode: no
      tags:
        - mount_option_dev_shm_nodev
        - unknown_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80152-2
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    - name: Ensure permission nodev are set on /dev/shm
      mount:
        path: "/dev/shm"
        src: "{{device_name.stdout}}"
        opts: "{{device_cur_mountoption.stdout}},nodev"
        state: "mounted"
        fstype: "{{device_fstype.stdout}}"
      tags:
        - mount_option_dev_shm_nodev
        - unknown_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80152-2
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2

    - name: Ensure sysctl kernel.kptr_restrict is set to 1
      sysctl:
        name: kernel.kptr_restrict
        value: 1
        state: present
        reload: yes
      tags:
        - sysctl_kernel_kptr_restrict
        - low_severity
        - disable_strategy
        - low_complexity
        - medium_disruption

    - name: Ensure sysctl kernel.randomize_va_space is set to 2
      sysctl:
        name: kernel.randomize_va_space
        value: 2
        state: present
        reload: yes
      tags:
        - sysctl_kernel_randomize_va_space
        - medium_severity
        - disable_strategy
        - low_complexity
        - medium_disruption
        - CCE-27127-0
        - NIST-800-53-SC-30(2)
        - NIST-800-171-3.1.7
        - DISA-STIG-RHEL-07-040201

    # Fixes carried
    - name: Copy E8 Audit rules
      copy:
        src: "rules/{{ item }}"
        dest: "/etc/audit/rules.d/{{ item }}"
        owner: root
        group: root
        mode: "0640"
      loop:
        - access.rules
        - actions.rules
        - audit.rules
        - audit_rules_networkconfig_modification.rules
        - audit_time_rules.rules
        - delete.rules
        - export.rules
        - logins.rules
        - MAC-policy.rules
        - modules.rules
        - privileged.rules
        - time-change.rules
      notify: reload_audit_rules

    - name: Set sshd LogLevel to INFO
      lineinfile:
        create: true
        dest: /etc/ssh/sshd_config
        regexp: ^LogLevel
        line: LogLevel INFO
      when: ansible_virtualization_role != "guest" or ansible_virtualization_type != "docker"
      tags:
        - set_loglevel_info
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - CCE-27413-4
        - NIST-800-53-AC-3
        - NIST-800-53-AC-17
        - NIST-800-53-CM-6(b)
        - NIST-800-171-3.1.12
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-010470
      notify: restart_sshd

    - name: Use strong MACs (sshd)
      lineinfile:
        create: true
        dest: /etc/ssh/sshd_config
        regexp: ^MACs
        line: "MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,hmac-ripemd160"
      when: ansible_virtualization_role != "guest" or ansible_virtualization_type != "docker"
      tags:
        - use_strong_macs
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - CCE-27413-4
        - NIST-800-53-AC-3
        - NIST-800-53-AC-17
        - NIST-800-53-CM-6(b)
        - NIST-800-171-3.1.12
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-010470
      notify: restart_sshd

    - name: Use strong ciphers (sshd)
      lineinfile:
        create: true
        dest: /etc/ssh/sshd_config
        regexp: ^Ciphers
        line: "Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes128-ctr"
      when: ansible_virtualization_role != "guest" or ansible_virtualization_type != "docker"
      tags:
        - use_strong_macs
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - CCE-27413-4
        - NIST-800-53-AC-3
        - NIST-800-53-AC-17
        - NIST-800-53-CM-6(b)
        - NIST-800-171-3.1.12
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-010470
      notify: restart_sshd

    - name: Get files in /etc/sudoers.d/
      find: 
        paths: /etc/sudoers.d
        recurse: yes
        file_type: file
      register: sudoers
      tags:
        - remove_sudoers_nopasswd

    - name: Append /etc/sudoers to list
      set_fact:
        sudoers: "{{ sudoers.files }} + [{'path':'/etc/sudoers'}] "
      tags: remove_sudoers_nopasswd

    # TODO backup sudoers files before modifying
    - name: Remove users from sudoers who have NOPASSWD specified
      lineinfile:
        path: "{{ item.path }}"
        state: absent
        regexp: '.*NOPASSWD:.*'
      loop: "{{ sudoers }}"
      tags: 
        - remove_sudoers_nopasswd

  handlers:

    - name: reload_audit_rules
      shell: augenrules

    - name: restart_sshd
      service:
        name: sshd
        state: restarted
